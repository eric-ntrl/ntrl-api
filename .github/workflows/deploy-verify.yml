name: Deploy Verification

on:
  push:
    branches: [main]

jobs:
  verify:
    name: Verify Staging Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Wait for deployment and health check
        run: |
          for i in $(seq 1 18); do
            if curl -sf https://api-staging-7b4d.up.railway.app/health > /dev/null 2>&1; then
              echo "Health check passed after $((i * 10))s"
              exit 0
            fi
            echo "Waiting... attempt $i/18"
            sleep 10
          done
          echo "Health check failed after 180s"
          exit 1

      - name: Brief endpoint check
        env:
          STAGING_KEY: ${{ secrets.STAGING_API_KEY }}
        run: |
          response=$(curl -s -o /dev/null -w '%{http_code}' -H "X-API-Key: $STAGING_KEY" https://api-staging-7b4d.up.railway.app/v1/brief)
          if [ "$response" != "200" ]; then
            echo "FAIL - Brief endpoint returned $response"
            exit 1
          fi
          echo "PASS - Brief endpoint returned 200"

      - name: Summary
        if: success()
        run: echo "Staging deploy verified successfully"

      - name: Failure notification
        if: failure()
        run: echo "WARNING - Staging deploy verification failed. Check Railway logs."
