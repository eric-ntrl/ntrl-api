name: Deploy Verification

on:
  push:
    branches: [main]

jobs:
  verify:
    name: Verify Staging Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Wait for Railway deploy
        run: echo "Waiting 120s for Railway..." && sleep 120

      - name: Health check
        run: |
          response=$(curl -s -o /dev/null -w '%{http_code}' https://api-staging-7b4d.up.railway.app/health)
          if [ "$response" != "200" ]; then
            echo "FAIL - Health check returned $response"
            exit 1
          fi
          echo "PASS - Health check returned 200"

      - name: Brief endpoint check
        env:
          STAGING_KEY: ${{ secrets.STAGING_API_KEY }}
        run: |
          response=$(curl -s -o /dev/null -w '%{http_code}' -H "X-API-Key: $STAGING_KEY" https://api-staging-7b4d.up.railway.app/v1/brief)
          if [ "$response" != "200" ]; then
            echo "FAIL - Brief endpoint returned $response"
            exit 1
          fi
          echo "PASS - Brief endpoint returned 200"

      - name: Summary
        if: success()
        run: echo "Staging deploy verified successfully"

      - name: Failure notification
        if: failure()
        run: echo "WARNING - Staging deploy verification failed. Check Railway logs."
